# library -----------------------------------------------------------------

library(tidyverse)
library(here)
library(bbr)
library(glue)
library(mrggsave)


# dir ---------------------------------------------------------------------

modelDir <- here("model/pk")
runno <- "001b"
sirrunno <- "001b-sir"
outputDir <- "./script/pkpdhub/pics"

options(mrggsave.dir = outputDir, mrggsave.dev = "png")
thisScript <- "sir_resampling.R"

# read in data sets generated by sir -------------------------------------
sirsample0 <- read.table(file.path(modelDir, sirrunno, glue("{sirrunno}.ext")), skip = 1, header = TRUE) 

sirsample1 <- sirsample0 %>% 
  mutate(dOFV = OBJ - OBJ[ITERATION == 0]) %>% 
  filter(ITERATION > 0)

names(sirsample1) <- gsub("\\.", "\\", names(sirsample1))

m <- sirsample1 %>% nrow() # number of sampling

# number of parameters in the original model
mod <- bbr::read_model(file.path(modelDir, runno))
nparam <- mod %>% model_summary() %>% param_estimates() %>% filter(fixed == FALSE) %>% nrow()

param_names <- mod %>% model_summary() %>% param_estimates() %>% filter(fixed == FALSE) %>% 
  mutate(parameter_names = str_replace_all(parameter_names, "\\(", "\\")) %>% 
  mutate(parameter_names = str_replace_all(parameter_names, "\\)", "\\")) %>% 
  mutate(parameter_names = str_replace_all(parameter_names, "\\,", "\\")) %>% 
  pull(parameter_names)

# resample method 1 ------------------------------------------------------

# compute resample probability based on importance ratios (WEIGHT)
sirsample1 <- sirsample1 %>% 
  mutate(prob = WEIGHT/sum(WEIGHT, na.rm = TRUE)) 

# resample
M1 <- 1000

withr::with_seed(seed = 0720, 
                 sample_rows <- sample(x = sirsample1$ITERATION, 
                                       size = M1, 
                                       replace = TRUE, 
                                       prob = sirsample1$prob)
)

sirresample1 <- sirsample1[sample_rows, ]

map_lgl(sirresample1, anyNA)

# resample method 2 -------------------------------------------------------

M2 <- 1000

sirinput <- glue("{modelDir}/{sirrunno}/{sirrunno}.ext")
siroutput <- glue("{modelDir}/{sirrunno}/{sirrunno}-rs.ext")

system(glue('/opt/NONMEM/nm75/util/table_resample {sirinput} {siroutput} s {M2} 0720'))

sirresample2 <- read.table(siroutput, skip = 1, header = TRUE) %>% 
  mutate(dOFV = OBJ - sirsample0[sirsample0$ITERATION == 0,]$OBJ) %>% 
  filter(ITERATION > 0)

names(sirresample2) <- gsub("\\.", "\\", names(sirresample2))


# dOFV plot (two method comparison) ---------------------------------------

sirresample1 <- sirresample1 %>% mutate(df = round(mean(dOFV), digits = 2))
sirresample2 <- sirresample2 %>% mutate(df = round(mean(dOFV), digits = 2))

p1 <- ggplot()+
  stat_ecdf(data = sirresample1, aes(x = dOFV), color = "red")+
  stat_ecdf(data = sirresample2, aes(x = dOFV), color = "blue")+
  geom_text(data = distinct(sirresample1, df), aes(x = 20, y = 0.25, label = glue("SIR df using method 1: {df}")), color = "red")+
  geom_text(data = distinct(sirresample2, df), aes(x = 22.5, y = 0.25, label = glue("SIR df using method 2: {df}")), color = "blue")+
  ylab("Cumulative probablity")+
  theme_bw()+
  coord_flip()

p1 

mrggsave_last(stem = "resample-dofv-comparison", 
              script = thisScript)


# dOFV final --------------------------------------------------------------

dofv_dt <- bind_rows(sirsample1 %>% dplyr::select(-WEIGHT, -prob) %>% mutate(df = round(mean(dOFV), digits = 2), type = "Proposal"), 
                     sirresample2 %>% mutate(type = "SIR"))

p2 <- ggplot()+
  stat_ecdf(data = dofv_dt, aes(x = dOFV, group = type, color = type))+
  stat_function(fun = pchisq, args = list(df = nparam), color = "gray20", linetype = 2)+
  geom_text(data = distinct(dofv_dt, df, .keep_all = TRUE), 
            aes(x = c(50, 35), y = 0.25, label = glue("Estimated df: {df}"), color = type))+
  geom_text(aes(x = 42.5, y = 0.25), label = glue("Theoretical Chi-Squared \nDistribution with {nparam} df"), color = "gray20")+
  theme_bw() + 
  ylab("Cumulative probablity")+
  coord_flip()+
  theme(legend.title = element_blank(), 
        legend.position = "bottom")

p2

mrggsave_last(stem = "dofv-example", 
              script = thisScript)
  

# ci plot -----------------------------------------------------------------

# SIR 95% CI
sirci <- sirresample2 %>% 
  dplyr::select(starts_with("THETA"), 
                starts_with("OMEGA"), 
                starts_with("SIGMA")) %>% 
  t() %>% 
  as.data.frame() %>% 
  rownames_to_column(var = "parameter") %>% 
  filter(parameter %in% param_names) %>% 
  rowwise() %>% 
  mutate(sir_median = median(c_across(!parameter)),  
         sir_lower = quantile(c_across(!parameter), 0.025), 
         sir_upper = quantile(c_across(!parameter), 0.975)) %>% 
  ungroup() %>% 
  mutate(type = "SIR") %>% 
  dplyr::select(parameter, sir_median, sir_lower, sir_upper, type) %>% 
  mutate(parameter = fct_inorder(parameter))

# 95% CI based on var-cov matrix (symmetrical)
covci <- mod %>% 
  model_summary() %>% 
  param_estimates() %>% 
  filter(fixed == FALSE) %>% 
  dplyr::select(parameter = parameter_names, estimate, stderr) %>% 
  mutate(final_lower = estimate - 1.96*stderr, 
         final_upper = estimate + 1.96*stderr) %>% 
  mutate(parameter = str_replace_all(parameter, "\\(", "\\")) %>% 
  mutate(parameter = str_replace_all(parameter, "\\)", "\\")) %>% 
  mutate(parameter = str_replace_all(parameter, "\\,", "\\")) %>% 
  mutate(type = "COV") %>% 
  dplyr::select(parameter, final_est = estimate, final_lower, final_upper, type) %>% 
  mutate(parameter = fct_inorder(parameter))

# side to side comparison plot
ggplot()+
  geom_point(data = sirci, aes(x=type, y=sir_median))+
  geom_point(data = covci, aes(x=type, y=final_est))+
  geom_errorbar(data = sirci, aes(x=type, ymin=sir_lower, ymax=sir_upper), width = 0.25)+
  geom_errorbar(data = covci, aes(x=type, ymin=final_lower, ymax=final_upper), width = 0.25)+
  theme_bw()+
  facet_wrap(~parameter, scales = "free")+
  xlab("")+
  ylab("95% CIs")

mrggsave_last(stem = "ci-plot", 
              script = thisScript, 
              width = 6, 
              height = 6)

# spatial trend plot ------------------------------------------------------

nbins1 <- 10       # number of spatial bins
mmratio <- M2/m    # sample to resample ratio
se <- sqrt(mmratio*(1-mmratio)/(m/nbins1)) # sqrt(P*(1-P) / number of samples at each spatial bin)

bins_sample <- sirsample1 %>% 
  dplyr::select(ITERATION, all_of(param_names)) %>% 
  mutate(across(all_of(param_names), .fns = ~cut_number(., n = 10))) %>% 
  mutate(across(all_of(param_names), .fns = as.integer))

bins_resample <- sirresample2 %>% dplyr::select(ITERATION) %>% left_join(bins_sample)

# sbins <- map(as.list(bins_sample[, names(bins_sample) %in% param_names]), levels) # extract spatial bins

bins_resample1 <- bins_resample %>% 
  pivot_longer(cols = all_of(param_names), names_to = "parameters", values_to = "bins") %>% 
  group_by(parameters, bins) %>% 
  mutate(prop = round(n()/(m/nbins1), digits = 2)) %>% 
  ungroup() %>% 
  distinct(parameters, bins, .keep_all = TRUE) %>% 
  mutate(parameters = fct_inorder(parameters))

ggplot(bins_resample1)+
  geom_point(aes(x = bins, y = prop))+
  geom_line(aes(x = bins, y = prop))+
  geom_ribbon(aes(x = bins, ymin = mmratio-1.96*se, ymax = mmratio+1.96*se), alpha = 0.25)+
  xlab("Spatial bin of initial samples")+
  ylab("Proportion resampled")+
  scale_x_continuous(limits = c(1, nbins1), breaks = seq(1,nbins1,1))+
  facet_wrap(~parameters)+
  theme_bw()

mrggsave_last(stem = "spatial-trend-plot", 
              script = thisScript, 
              width = 6, 
              height = 6)

# temporal trend plot -----------------------------------------------------

nbins2 <- 5     # number of temporal bins

# identify top spatial bin
top_sbins <- bins_resample1 %>% 
  arrange(parameters, desc(prop)) %>% 
  group_by(parameters) %>% 
  slice(1) %>% 
  ungroup() %>% 
  dplyr::select(parameters, top_sbins = bins, p = prop) %>% 
  mutate(se = sqrt(p*(1-p)/(m/(nbins1*nbins2)))) # sqrt(P*(1-P) / number of samples at each temporal bin)

# filter parameter by parameter that belongs to the top_bins
bins_resample2 <- bins_resample %>% 
  left_join(sirsample1 %>% dplyr::select(ITERATION, WEIGHT)) %>% 
  mutate(bins = cut_number(WEIGHT, n = nbins2)) %>% 
  mutate(bins = (6 - as.integer(bins))) %>% # reverse order, higher WEIGHT, lower order
  pivot_longer(cols = all_of(param_names), names_to = "parameters", values_to = "sbins") %>% 
  left_join(top_sbins) %>% 
  mutate(parameters = fct_inorder(parameters)) %>% 
  filter(sbins == top_sbins) %>% # filter resampled parameters in the top spatial bin
  dplyr::select(-ITERATION, -WEIGHT, -sbins) %>% 
  mutate(top_sbins = glue("Spatial bin {top_sbins}")) %>% 
  group_by(parameters, bins) %>% 
  mutate(n = n()) %>% 
  ungroup() 

ggplot(bins_resample2)+
  geom_point(aes(x = bins, y = n))+
  geom_line(aes(x = bins, y = n))+
  geom_text(aes(x = 3, y = 0.9*max(n), label = top_sbins))+
  geom_ribbon(aes(x = bins, ymin = (p-1.96*se)*(m/(nbins1*nbins2)), ymax = (p+1.96*se)*(m/(nbins1*nbins2))), alpha = 0.5)+
  xlab("Temporal bin of resamples")+
  ylab("Number of parameters resampled")+
  scale_x_continuous(limits = c(1, nbins2), breaks = seq(1,nbins2,1))+
  facet_wrap(~parameters)+
  theme_bw()

mrggsave_last(stem = "temporal-trend-plot", 
              script = thisScript, 
              width = 6, 
              height = 6)


###########################################################################
#################### Sensitivity Analysis #################################
###########################################################################

# dOFV SIRDF sens ---------------------------------------------------------

# we will use NONMEM resampling method for the downstream analysis

sens1_dir <- file.path(modelDir, glue("{sirrunno}-sirdf"))

# resampling using NONMEM
# system(glue('/opt/NONMEM/nm75/util/table_resample {sens1_dir}/{sirrunno}-1/{sirrunno}-1.ext {sens1_dir}/{sirrunno}-1/{sirrunno}-1-rs.ext s {M2} 0720'))
# system(glue('/opt/NONMEM/nm75/util/table_resample {sens1_dir}/{sirrunno}-2/{sirrunno}-2.ext {sens1_dir}/{sirrunno}-2/{sirrunno}-2-rs.ext s {M2} 0720'))
# system(glue('/opt/NONMEM/nm75/util/table_resample {sens1_dir}/{sirrunno}-3/{sirrunno}-3.ext {sens1_dir}/{sirrunno}-3/{sirrunno}-3-rs.ext s {M2} 0720'))
# system(glue('/opt/NONMEM/nm75/util/table_resample {sens1_dir}/{sirrunno}-4/{sirrunno}-4.ext {sens1_dir}/{sirrunno}-4/{sirrunno}-4-rs.ext s {M2} 0720'))

sirsample_sens1_0 <- sirsample1 %>% mutate(SIRDF = 0, df = round(mean(dOFV), digits = 2)) %>% dplyr::select(-prob)

sirsample_sens1_1 <- read.table(glue("{sens1_dir}/{sirrunno}-1/{sirrunno}-1.ext"), skip = 1, header = TRUE) %>% 
  mutate(dOFV = OBJ - sirsample0[sirsample0$ITERATION == 0,]$OBJ) %>% 
  filter(ITERATION > 0) %>% 
  mutate(SIRDF = 2, df = round(mean(dOFV), digits = 2))

sirsample_sens1_2 <- read.table(glue("{sens1_dir}/{sirrunno}-2/{sirrunno}-2.ext"), skip = 1, header = TRUE) %>% 
  mutate(dOFV = OBJ - sirsample0[sirsample0$ITERATION == 0,]$OBJ) %>% 
  filter(ITERATION > 0) %>% 
  mutate(SIRDF = 4, df = round(mean(dOFV), digits = 2))

sirsample_sens1_3 <- read.table(glue("{sens1_dir}/{sirrunno}-3/{sirrunno}-3.ext"), skip = 1, header = TRUE) %>% 
  mutate(dOFV = OBJ - sirsample0[sirsample0$ITERATION == 0,]$OBJ) %>% 
  filter(ITERATION > 0) %>% 
  mutate(SIRDF = 6, df = round(mean(dOFV), digits = 2))

sirsample_sens1_4 <- read.table(glue("{sens1_dir}/{sirrunno}-4/{sirrunno}-4.ext"), skip = 1, header = TRUE) %>% 
  mutate(dOFV = OBJ - sirsample0[sirsample0$ITERATION == 0,]$OBJ) %>% 
  filter(ITERATION > 0) %>% 
  mutate(SIRDF = 8, df = round(mean(dOFV), digits = 2))

sirsample_sens1 <- bind_rows(sirsample_sens1_0, 
                             sirsample_sens1_4, 
                             sirsample_sens1_3,
                             sirsample_sens1_2, 
                             sirsample_sens1_1) %>% 
  mutate(SIRDF = as.factor(SIRDF)) %>% 
  mutate(df = glue("Estimated df: {df}"))

ggplot(sirsample_sens1)+
  stat_ecdf(aes(x = dOFV, group = SIRDF, color = SIRDF))+
  stat_function(fun = pchisq, args = list(df = nparam), linetype = 2)+
  geom_text(data = distinct(sirsample_sens1, SIRDF, .keep_all = TRUE), 
            aes(x = seq(24, 40, 4), y = 0.5, label = df, color = SIRDF))+
  geom_text(aes(x = 6, y = 0.75), label = glue("Theoretical Chi-Squared Distribution \nwith {nparam} df"), color = "gray20")+
  theme_bw()+
  ylab("Cumulative probablity")+
  coord_flip()+
  theme(legend.position = "bottom")

mrggsave_last(stem = "sirdf-sens-dofv", 
              script = thisScript, 
              width = 6, 
              height = 6)

# t distribution plots
sirdf <- data <- data.frame(x = rep(seq(-5,5,0.1), 4), 
                            df = rep(c(2, 4, 6, 8), each = 101)) %>% 
  mutate(y = dt(x = x, df = df)) %>% 
  mutate(df = as.factor(df)) %>% 
  rename(`DF of t-distribution` = df)

ggplot()+
  geom_line(data = sirdf, aes(x = x, y = y, group = `DF of t-distribution`, color = `DF of t-distribution`))+
  stat_function(fun = dnorm)+
  geom_text(aes(x = 2.5, y = 0.3, label = "Normal Distribution"))+
  ylab("Probability density function")+
  theme_bw() +
  theme(legend.position = "bottom")

mrggsave_last(stem = "sirdf-shape", 
              script = thisScript)

# extract run times

t0 <- readLines(file.path(modelDir, "001b-sir", "001b-sir.lst"))
t1 <- readLines(file.path(sens1_dir, "001b-sir-1/001b-sir-1.lst"))
t2 <- readLines(file.path(sens1_dir, "001b-sir-2/001b-sir-2.lst"))
t3 <- readLines(file.path(sens1_dir, "001b-sir-3/001b-sir-3.lst"))
t4 <- readLines(file.path(sens1_dir, "001b-sir-4/001b-sir-4.lst"))

t0 <- gsub("[^0-9.]", "",  t0[grep("#CPUT: Total CPU Time in Seconds,", t0)]) %>% as.numeric
t1 <- gsub("[^0-9.]", "",  t1[grep("#CPUT: Total CPU Time in Seconds,", t1)]) %>% as.numeric
t2 <- gsub("[^0-9.]", "",  t2[grep("#CPUT: Total CPU Time in Seconds,", t2)]) %>% as.numeric
t3 <- gsub("[^0-9.]", "",  t3[grep("#CPUT: Total CPU Time in Seconds,", t3)]) %>% as.numeric
t4 <- gsub("[^0-9.]", "",  t4[grep("#CPUT: Total CPU Time in Seconds,", t4)]) %>% as.numeric

cpu_time1 <- data.frame(sirdf = c(0,8,6,4,2), 
                        cputime = c(t0, t4, t3, t2, t1)) %>% 
  mutate(sirdf = glue::glue("SIRDF={sirdf}")) %>% 
  mutate(sirdf = fct_inorder(sirdf)) 

ggplot(cpu_time1)+
  geom_bar(aes(x = sirdf, y = cputime), stat = "identity")+
  xlab("")+
  ylab("CPU Time (seconds)")+
  scale_y_continuous(limits = c(0, 3500))+
  theme_bw()+
  pmplots::rot_x()

mrggsave_last(stem = "sirdf-time", 
              script = thisScript)

# dOFV IACCEPT sens -------------------------------------------------------

# we will use NONMEM resampling method for the downstream analysis

sens3_dir <- file.path(modelDir, glue("{sirrunno}-iaccept"))

# # resampling using NONMEM
# system(glue('/opt/NONMEM/nm75/util/table_resample {sens3_dir}/{sirrunno}-1/{sirrunno}-1.ext {sens3_dir}/{sirrunno}-1/{sirrunno}-1-rs.ext s {M2} 0720'))
# system(glue('/opt/NONMEM/nm75/util/table_resample {sens3_dir}/{sirrunno}-2/{sirrunno}-2.ext {sens3_dir}/{sirrunno}-2/{sirrunno}-2-rs.ext s {M2} 0720'))
# system(glue('/opt/NONMEM/nm75/util/table_resample {sens3_dir}/{sirrunno}-3/{sirrunno}-3.ext {sens3_dir}/{sirrunno}-3/{sirrunno}-3-rs.ext s {M2} 0720'))
# system(glue('/opt/NONMEM/nm75/util/table_resample {sens3_dir}/{sirrunno}-4/{sirrunno}-4.ext {sens3_dir}/{sirrunno}-4/{sirrunno}-4-rs.ext s {M2} 0720'))

sirsample_sens3_0 <- sirsample1 %>% mutate(IACCEPT = 1, df = round(mean(dOFV), digits = 2)) %>% dplyr::select(-prob)

sirsample_sens3_1 <- read.table(glue("{sens3_dir}/{sirrunno}-1/{sirrunno}-1.ext"), skip = 1, header = TRUE) %>% 
  mutate(dOFV = OBJ - sirsample0[sirsample0$ITERATION == 0,]$OBJ) %>% 
  filter(ITERATION > 0) %>% 
  mutate(IACCEPT = 0.2, df = round(mean(dOFV), digits = 2))

sirsample_sens3_2 <- read.table(glue("{sens3_dir}/{sirrunno}-2/{sirrunno}-2.ext"), skip = 1, header = TRUE) %>% 
  mutate(dOFV = OBJ - sirsample0[sirsample0$ITERATION == 0,]$OBJ) %>% 
  filter(ITERATION > 0) %>% 
  mutate(IACCEPT = 0.4, df = round(mean(dOFV), digits = 2))

sirsample_sens3_3 <- read.table(glue("{sens3_dir}/{sirrunno}-3/{sirrunno}-3.ext"), skip = 1, header = TRUE) %>% 
  mutate(dOFV = OBJ - sirsample0[sirsample0$ITERATION == 0,]$OBJ) %>% 
  filter(ITERATION > 0) %>% 
  mutate(IACCEPT = 0.6, df = round(mean(dOFV), digits = 2))

sirsample_sens3_4 <- read.table(glue("{sens3_dir}/{sirrunno}-4/{sirrunno}-4.ext"), skip = 1, header = TRUE) %>% 
  mutate(dOFV = OBJ - sirsample0[sirsample0$ITERATION == 0,]$OBJ) %>% 
  filter(ITERATION > 0) %>% 
  mutate(IACCEPT = 0.8, df = round(mean(dOFV), digits = 2))

sirsample_sens3 <- bind_rows(sirsample_sens3_0, 
                             sirsample_sens3_4, 
                             sirsample_sens3_3,
                             sirsample_sens3_2, 
                             sirsample_sens3_1) %>% 
  mutate(IACCEPT = as.factor(IACCEPT)) %>% 
  mutate(df = glue("Estimated df: {df}"))

ggplot(sirsample_sens3)+
  stat_ecdf(aes(x = dOFV, group = IACCEPT, color = IACCEPT))+
  stat_function(fun = pchisq, args = list(df = nparam), linetype = 2)+
  geom_text(data = distinct(sirsample_sens3, IACCEPT, .keep_all = TRUE), 
            aes(x = seq(24, 40, 4), y = 0.25, label = df, color = IACCEPT))+
  geom_text(aes(x = 6, y = 0.75), label = glue("Theoretical Chi-Squared Distribution \nwith {nparam} df"), color = "gray20")+
  theme_bw()+
  ylab("Cumulative probablity")+
  coord_flip()+
  theme(legend.position = "bottom")

mrggsave_last(stem = "iaccept-sens-dofv", 
              script = thisScript, 
              width = 6, 
              height = 6)

# scale variance plots
iaccept <- data <- data.frame(x = rep(seq(-5,5,0.1), 5), 
                            sd_scale = rep(c(0.2, 0.4, 0.6, 0.8, 1), each = 101)) %>% 
  mutate(y = dnorm(x = x, mean = 0, sd = 1/sqrt(sd_scale))) %>% 
  mutate(sd_scale = as.factor(sd_scale)) %>% 
  rename(`Variance scaling` = sd_scale)

ggplot()+
  geom_line(data = iaccept, aes(x = x, y = y, group = `Variance scaling`, color = `Variance scaling`))+
  ylab("Probability density function")+
  theme_bw() +
  theme(legend.position = "bottom")

mrggsave_last(stem = "iaccept-shape", 
              script = thisScript)

# extract run times

t0 <- readLines(file.path(modelDir, "001b-sir", "001b-sir.lst"))
t1 <- readLines(file.path(sens3_dir, "001b-sir-1/001b-sir-1.lst"))
t2 <- readLines(file.path(sens3_dir, "001b-sir-2/001b-sir-2.lst"))
t3 <- readLines(file.path(sens3_dir, "001b-sir-3/001b-sir-3.lst"))
t4 <- readLines(file.path(sens3_dir, "001b-sir-4/001b-sir-4.lst"))

t0 <- gsub("[^0-9.]", "",  t0[grep("#CPUT: Total CPU Time in Seconds,", t0)]) %>% as.numeric
t1 <- gsub("[^0-9.]", "",  t1[grep("#CPUT: Total CPU Time in Seconds,", t1)]) %>% as.numeric
t2 <- gsub("[^0-9.]", "",  t2[grep("#CPUT: Total CPU Time in Seconds,", t2)]) %>% as.numeric
t3 <- gsub("[^0-9.]", "",  t3[grep("#CPUT: Total CPU Time in Seconds,", t3)]) %>% as.numeric
t4 <- gsub("[^0-9.]", "",  t4[grep("#CPUT: Total CPU Time in Seconds,", t4)]) %>% as.numeric

cpu_time2 <- data.frame(iaccept = c(1,0.8,0.6,0.4,0.2), 
                        cputime = c(t0, t4, t3, t2, t1)) %>% 
  mutate(iaccept = glue::glue("IACCEPT={iaccept}")) %>% 
  mutate(iaccept = fct_inorder(iaccept)) 

ggplot(cpu_time2)+
  geom_bar(aes(x = iaccept, y = cputime), stat = "identity")+
  xlab("")+
  ylab("CPU Time (seconds)")+
  scale_y_continuous(limits = c(0, 3500))+
  theme_bw()+
  pmplots::rot_x()

mrggsave_last(stem = "iaccept-time", 
              script = thisScript)


# dOFV m/M ratio sens -----------------------------------------------------

# resampling using NONMEM
# taking sirdf = 4 as an example
# five tested ratio: 1,2,5,10,20

sens2_dir <- file.path(modelDir, glue("{sirrunno}-mmratio"))

# resampling using NONMEM
# system(glue('/opt/NONMEM/nm75/util/table_resample {sens2_dir}/{sirrunno}-1/{sirrunno}-1.ext {sens2_dir}/{sirrunno}-1/{sirrunno}-1-rs.ext s {M2} -0720'))
# system(glue('/opt/NONMEM/nm75/util/table_resample {sens2_dir}/{sirrunno}-2/{sirrunno}-2.ext {sens2_dir}/{sirrunno}-2/{sirrunno}-2-rs.ext s {M2} -0720'))
# system(glue('/opt/NONMEM/nm75/util/table_resample {sens2_dir}/{sirrunno}-3/{sirrunno}-3.ext {sens2_dir}/{sirrunno}-3/{sirrunno}-3-rs.ext s {M2} -0720'))
# system(glue('/opt/NONMEM/nm75/util/table_resample {sens2_dir}/{sirrunno}-4/{sirrunno}-4.ext {sens2_dir}/{sirrunno}-4/{sirrunno}-4-rs.ext s {M2} -0720'))
# system(glue('/opt/NONMEM/nm75/util/table_resample {sens2_dir}/{sirrunno}-5/{sirrunno}-5.ext {sens2_dir}/{sirrunno}-5/{sirrunno}-5-rs.ext s {M2} -0720'))

sirresample_sens2_1 <- read.table(glue("{sens2_dir}/{sirrunno}-1/{sirrunno}-1-rs.ext"), skip = 1, header = TRUE) %>% 
  mutate(dOFV = OBJ - sirsample0[sirsample0$ITERATION == 0,]$OBJ) %>% 
  filter(ITERATION > 0) %>% 
  mutate(`m/M` = "1000/1000", df = round(mean(dOFV), digits = 2))

sirresample_sens2_2 <- read.table(glue("{sens2_dir}/{sirrunno}-2/{sirrunno}-2-rs.ext"), skip = 1, header = TRUE) %>% 
  mutate(dOFV = OBJ - sirsample0[sirsample0$ITERATION == 0,]$OBJ) %>% 
  filter(ITERATION > 0) %>% 
  mutate(`m/M` = "2000/1000", df = round(mean(dOFV), digits = 2))

sirresample_sens2_3 <- read.table(glue("{sens2_dir}/{sirrunno}-3/{sirrunno}-3-rs.ext"), skip = 1, header = TRUE) %>% 
  mutate(dOFV = OBJ - sirsample0[sirsample0$ITERATION == 0,]$OBJ) %>% 
  filter(ITERATION > 0) %>% 
  mutate(`m/M` = "5000/1000", df = round(mean(dOFV), digits = 2))

sirresample_sens2_4 <- read.table(glue("{sens2_dir}/{sirrunno}-4/{sirrunno}-4-rs.ext"), skip = 1, header = TRUE) %>% 
  mutate(dOFV = OBJ - sirsample0[sirsample0$ITERATION == 0,]$OBJ) %>% 
  filter(ITERATION > 0) %>% 
  mutate(`m/M` = "7500/1000", df = round(mean(dOFV), digits = 2))

sirresample_sens2_5 <- read.table(glue("{sens2_dir}/{sirrunno}-5/{sirrunno}-5-rs.ext"), skip = 1, header = TRUE) %>%
  mutate(dOFV = OBJ - sirsample0[sirsample0$ITERATION == 0,]$OBJ) %>%
  filter(ITERATION > 0) %>%
  mutate(`m/M` = "10000/1000", df = round(mean(dOFV), digits = 2))

sirresample_sens2 <- bind_rows(sirresample_sens2_1, 
                               sirresample_sens2_2, 
                               sirresample_sens2_3, 
                               sirresample_sens2_4, 
                               sirresample_sens2_5) %>% 
  mutate(`m/M` = as.factor(`m/M`)) %>% 
  mutate(df = glue("Estimated df: {df}")) %>% 
  mutate(`m/M` = fct_inorder(`m/M`))

ggplot(sirresample_sens2)+
  stat_ecdf(aes(x = dOFV, group = `m/M`, color = `m/M`))+
  stat_function(fun = pchisq, args = list(df = nparam), linetype = 2)+
  geom_text(data = distinct(sirresample_sens2, `m/M`, .keep_all = TRUE), 
            aes(x = seq(29.6, 20, -2.4), y = 0.25, label = df, color = `m/M`))+
  geom_text(aes(x = 6, y = 0.75), label = glue("Theoretical Chi-Squared Distribution \nwith {nparam} df"), color = "gray20")+
  theme_bw()+
  coord_flip()

mrggsave_last(stem = "mmratio-sens-dofv", 
              script = thisScript, 
              width = 6.5, 
              height = 6)


# extract run times

t1 <- readLines(file.path(sens2_dir, "001b-sir-1/001b-sir-1.lst"))
t2 <- readLines(file.path(sens2_dir, "001b-sir-2/001b-sir-2.lst"))
t3 <- readLines(file.path(sens2_dir, "001b-sir-3/001b-sir-3.lst"))
t4 <- readLines(file.path(sens2_dir, "001b-sir-4/001b-sir-4.lst"))
t5 <- readLines(file.path(sens2_dir, "001b-sir-5/001b-sir-5.lst"))

t1 <- gsub("[^0-9.]", "",  t1[grep("#CPUT: Total CPU Time in Seconds,", t1)]) %>% as.numeric
t2 <- gsub("[^0-9.]", "",  t2[grep("#CPUT: Total CPU Time in Seconds,", t2)]) %>% as.numeric
t3 <- gsub("[^0-9.]", "",  t3[grep("#CPUT: Total CPU Time in Seconds,", t3)]) %>% as.numeric
t4 <- gsub("[^0-9.]", "",  t4[grep("#CPUT: Total CPU Time in Seconds,", t4)]) %>% as.numeric
t5 <- gsub("[^0-9.]", "",  t5[grep("#CPUT: Total CPU Time in Seconds,", t5)]) %>% as.numeric

cpu_time2 <- data.frame(sirsample = c(1000,2000,5000,7500,10000), 
                        cputime = c(t1, t2, t3, t4, t5)) %>% 
  mutate(sirsample = glue::glue("SIRSAMPLE={sirsample}")) %>% 
  mutate(sirsample = fct_inorder(sirsample)) 

ggplot(cpu_time2)+
  geom_bar(aes(x = sirsample, y = cputime), stat = "identity")+
  xlab("")+
  ylab("CPU Time (seconds)")+
  theme_bw()+
  pmplots::rot_x()

mrggsave_last(stem = "sirsample-time", 
              script = thisScript)













